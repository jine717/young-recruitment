# NEW WORKFLOW - Business Case Questions Video Implementation

## Resumen Ejecutivo

Este documento detalla la implementaciÃ³n del nuevo workflow para Business Case Questions (BCQ) separando la aplicaciÃ³n inicial de la evaluaciÃ³n mediante video, aÃ±adiendo tracking de tiempos y anÃ¡lisis de IA.

---

## **FASE 1: ModificaciÃ³n del Formulario de AplicaciÃ³n** âœ… IN PROGRESS
**DuraciÃ³n estimada: 1-2 dÃ­as**

### 1.1 Cambios en `src/pages/Apply.tsx`
- [x] **Eliminar** la secciÃ³n de Business Case Questions del formulario
- [x] **Eliminar** la validaciÃ³n de respuestas BCQ obligatorias
- [x] **Modificar** el estado de la aplicaciÃ³n creada:
  - `business_case_completed: false` (en lugar de `true`)
  - `business_case_completed_at: null`
- [x] **Eliminar** la inserciÃ³n de `business_case_responses` en el submit
- [x] **NO ejecutar** `analyze-candidate` al aplicar (se moverÃ¡ a despuÃ©s de completar BCQ)

### 1.2 Cambios en Base de Datos (Siguiente paso)
AÃ±adir nuevas columnas a `applications`:
```sql
ALTER TABLE applications ADD COLUMN bcq_invitation_sent_at TIMESTAMPTZ;
ALTER TABLE applications ADD COLUMN bcq_link_opened_at TIMESTAMPTZ;
ALTER TABLE applications ADD COLUMN bcq_started_at TIMESTAMPTZ;
ALTER TABLE applications ADD COLUMN bcq_completed_at TIMESTAMPTZ;
ALTER TABLE applications ADD COLUMN bcq_response_time_minutes INTEGER;
ALTER TABLE applications ADD COLUMN bcq_delayed BOOLEAN DEFAULT false;
ALTER TABLE applications ADD COLUMN bcq_access_token UUID;
```

### 1.3 Resultado
- Los candidatos aplican solo con: Nombre, Email, CV, DISC
- La aplicaciÃ³n aparece en el dashboard como "New" sin BCQ completado
- El AI Score no se calcula hasta completar BCQ

---

## **FASE 2: Sistema de InvitaciÃ³n por Email para BCQ**
**DuraciÃ³n estimada: 2-3 dÃ­as**

### 2.1 Nuevo Template de Email
AÃ±adir a `send-notification` edge function:
- **Tipo:** `bcq_invitation`
- **Contenido:** 
  - Mensaje de bienvenida
  - Enlace Ãºnico: `/bcq/{applicationId}/{token}`
  - Instrucciones sobre formato video en inglÃ©s
  - Recordatorio que serÃ¡ transcrito

### 2.2 GeneraciÃ³n de Token Seguro
- Usar columna `bcq_access_token` en `applications`
- Generar token Ãºnico UUID al enviar invitaciÃ³n
- Token vÃ¡lido solo para esa aplicaciÃ³n

### 2.3 Trigger AutomÃ¡tico
Modificar `src/pages/Apply.tsx` para:
1. Crear la aplicaciÃ³n
2. **AutomÃ¡ticamente** enviar email de invitaciÃ³n BCQ
3. Guardar `bcq_invitation_sent_at`

### 2.4 Template de Reminder (24h) - Opcional
- **Tipo:** `bcq_reminder`
- Se enviarÃ¡ si no completan en 24h
- Edge function cron o trigger manual

---

## **FASE 3: Nueva PÃ¡gina de Respuesta BCQ en Video**
**DuraciÃ³n estimada: 4-5 dÃ­as**

### 3.1 Nueva Ruta y PÃ¡gina
Crear `src/pages/BusinessCasePortal.tsx`:
- Ruta: `/bcq/:applicationId/:token`
- Validar token antes de mostrar contenido
- Registrar `bcq_link_opened_at` al cargar

### 3.2 Interfaz de Preguntas (1 por 1)
- Mostrar una pregunta a la vez
- NavegaciÃ³n: Anterior / Siguiente
- Progress bar visual
- **Registrar** `bcq_started_at` al iniciar primera respuesta

### 3.3 Componente de GrabaciÃ³n de Video
Crear `src/components/bcq/VideoRecorder.tsx`:
- Captura de video desde cÃ¡mara
- LÃ­mite de tiempo por pregunta (ej: 3 minutos)
- Preview antes de confirmar
- BotÃ³n "Re-grabar" si no satisfecho

### 3.4 Upload de Video
- Subir a bucket `business-case-videos`
- Mostrar progreso de upload
- Guardar URL en `business_case_responses.video_url`

### 3.5 TranscripciÃ³n AutomÃ¡tica
Al guardar cada respuesta:
1. Enviar video a `transcribe-video` edge function
2. Guardar transcripciÃ³n en `business_case_responses.text_response`
3. Idioma forzado: `language: 'en'` (inglÃ©s)

### 3.6 FinalizaciÃ³n
Al completar todas las preguntas:
1. Calcular `bcq_response_time_minutes` (desde `bcq_link_opened_at`)
2. Marcar `business_case_completed: true`
3. Guardar `bcq_completed_at`
4. Mostrar pantalla de confirmaciÃ³n

---

## **FASE 4: Tracking de Tiempo y Estado "Delayed"**
**DuraciÃ³n estimada: 1-2 dÃ­as**

### 4.1 CÃ¡lculo de Delayed
- Si `bcq_completed_at - bcq_invitation_sent_at > 24 horas`:
  - Marcar `bcq_delayed: true`
- Implementar en el submit de BCQ Portal

### 4.2 Mostrar en Dashboard
Modificar `src/pages/RecruiterDashboard.tsx`:
- Nueva columna o badge: "BCQ Status"
- Estados posibles:
  - ğŸŸ¡ "Pending" (invitaciÃ³n enviada, no completado)
  - ğŸŸ¢ "Completed" (en tiempo)
  - ğŸ”´ "Delayed" (>24h)
  - â±ï¸ Mostrar "Response Time: Xh Ym"

### 4.3 Filtros de Dashboard
- AÃ±adir filtro por BCQ status
- Permitir ordenar por tiempo de respuesta

---

## **FASE 5: Email de ConfirmaciÃ³n Post-BCQ**
**DuraciÃ³n estimada: 1 dÃ­a**

### 5.1 Nuevo Template de Email
AÃ±adir a `send-notification`:
- **Tipo:** `bcq_completed`
- **Contenido:**
  - ConfirmaciÃ³n de recepciÃ³n
  - "Tu aplicaciÃ³n serÃ¡ revisada por el equipo de recruitment"
  - PrÃ³ximos pasos

### 5.2 Trigger AutomÃ¡tico
En `BusinessCasePortal.tsx`, al completar:
1. Enviar notificaciÃ³n `bcq_completed`
2. Registrar en `notification_logs`

---

## **FASE 6: ReorganizaciÃ³n de Tabs en Candidate Profile**
**DuraciÃ³n estimada: 2-3 dÃ­as**

### 6.1 Nueva Estructura de Tabs
Modificar `src/pages/CandidateProfile.tsx`:
- **Tab "Overview"**: AI Evaluation, CV & DISC Analysis (sin BCQ)
- **Tab "BCQ"** (NUEVO): Business Case Questions con videos
- **Tab "Interview"**: Interview Questions + Schedule

### 6.2 Nuevo Componente BCQ Tab
Crear `src/components/candidate-profile/BCQTab.tsx`:
- Lista de preguntas con sus respuestas en video
- Mostrar informaciÃ³n de timing:
  - "Invitation sent: [fecha]"
  - "Completed: [fecha]"
  - "Response time: [Xh Ym]"
  - Badge "Delayed" si aplica

---

## **FASE 7: VisualizaciÃ³n de Videos y TranscripciÃ³n**
**DuraciÃ³n estimada: 2-3 dÃ­as**

### 7.1 Componente de Video Player
Crear `src/components/candidate-profile/BCQResponseCard.tsx`:
- Video player embebido
- TranscripciÃ³n debajo del video
- Badge de estado de transcripciÃ³n

### 7.2 Layout por Pregunta
Para cada Business Case Question:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Question 1: [TÃ­tulo]                â”‚
â”‚ [DescripciÃ³n de la pregunta]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ¥ [Video Player]                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“ Transcription:                   â”‚
â”‚ "[Texto transcrito...]"             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ¤– [Analyze with AI] Button         â”‚
â”‚ AI Analysis (si existe):            â”‚
â”‚ - Response quality                  â”‚
â”‚ - English fluency                   â”‚
â”‚ - Key points                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## **FASE 8: AnÃ¡lisis de IA para BCQ**
**DuraciÃ³n estimada: 3-4 dÃ­as**

### 8.1 Nueva Edge Function `analyze-bcq-response`
- Recibe: `application_id`, `business_case_id`
- Analiza:
  - **Calidad de respuesta**: relevancia, profundidad, estructura
  - **Fluidez en inglÃ©s**: gramÃ¡tica, vocabulario, coherencia
  - **Puntos clave identificados**
  - **PuntuaciÃ³n** (0-100) por respuesta

### 8.2 Almacenamiento de AnÃ¡lisis
Crear tabla `bcq_analyses`:
```sql
CREATE TABLE bcq_analyses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  business_case_response_id UUID REFERENCES business_case_responses(id),
  response_quality_score INTEGER,
  english_fluency_score INTEGER,
  key_points TEXT[],
  analysis_summary TEXT,
  raw_ai_response JSONB,
  created_at TIMESTAMPTZ DEFAULT now()
);
```

### 8.3 BotÃ³n "Analyze with AI" en UI
- Trigger individual por respuesta
- Loading state durante anÃ¡lisis
- Mostrar resultados inline despuÃ©s del anÃ¡lisis

---

## **FASE 9: AI Score Integrado Post-BCQ**
**DuraciÃ³n estimada: 2-3 dÃ­as**

### 9.1 Modificar Trigger de AI Score
Cambiar lÃ³gica para que `analyze-candidate`:
- **NO** se ejecute al aplicar
- **SÃ** se ejecute automÃ¡ticamente al completar BCQ

### 9.2 Modificar Edge Function `analyze-candidate`
Actualizar para incluir en el anÃ¡lisis:
- CV Analysis
- DISC Analysis
- **BCQ Responses** (nuevo):
  - Videos/transcripciones
  - AnÃ¡lisis de IA de cada respuesta (si existe)
  - Puntuaciones de fluidez en inglÃ©s
  - Calidad de respuestas

### 9.3 PonderaciÃ³n del AI Score
```
AI Score = weighted average of:
- CV Analysis (30%)
- DISC Analysis (20%)
- BCQ Quality Average (30%)
- English Fluency Average (20%)
```

### 9.4 Dashboard Update
- AI Score solo visible cuando BCQ completado
- Mostrar "Pending BCQ" si no completado

---

## **FASE 10: Testing y Refinamiento**
**DuraciÃ³n estimada: 2-3 dÃ­as**

### 10.1 Testing E2E
1. Aplicar a un puesto (sin BCQ)
2. Recibir email de invitaciÃ³n
3. Acceder al portal BCQ
4. Grabar videos para cada pregunta
5. Verificar transcripciÃ³n
6. Verificar email de confirmaciÃ³n
7. Verificar apariciÃ³n en dashboard con timing
8. Verificar anÃ¡lisis de IA
9. Verificar AI Score final

### 10.2 Edge Cases
- Navegador sin permisos de cÃ¡mara
- ConexiÃ³n lenta para upload
- Token expirado/invÃ¡lido
- Respuestas parciales (abandonar a mitad)

---

## **Resumen de Archivos a Crear/Modificar**

### Nuevos Archivos:
| Archivo | DescripciÃ³n |
|---------|-------------|
| `src/pages/BusinessCasePortal.tsx` | Portal para responder BCQ en video |
| `src/components/bcq/VideoRecorder.tsx` | GrabaciÃ³n de video |
| `src/components/bcq/QuestionNavigator.tsx` | NavegaciÃ³n entre preguntas |
| `src/components/candidate-profile/BCQTab.tsx` | Tab BCQ en perfil |
| `src/components/candidate-profile/BCQResponseCard.tsx` | Card de respuesta con video |
| `src/hooks/useBCQPortal.ts` | Hook para portal BCQ |
| `supabase/functions/analyze-bcq-response/index.ts` | AnÃ¡lisis IA de respuesta |

### Archivos a Modificar:
| Archivo | Cambios |
|---------|---------|
| `src/pages/Apply.tsx` | Eliminar BCQ, cambiar flags |
| `src/pages/CandidateProfile.tsx` | AÃ±adir Tab BCQ |
| `src/pages/RecruiterDashboard.tsx` | AÃ±adir columna BCQ status |
| `supabase/functions/send-notification/index.ts` | Nuevos templates |
| `supabase/functions/analyze-candidate/index.ts` | Incluir BCQ analysis |

### Migraciones de Base de Datos:
1. AÃ±adir columnas BCQ tracking a `applications`
2. Crear tabla `bcq_analyses`

---

## **Timeline Estimado Total: 3-4 semanas**

| Fase | DuraciÃ³n | Dependencias | Estado |
|------|----------|--------------|--------|
| Fase 1 | 1-2 dÃ­as | - | âœ… IN PROGRESS |
| Fase 2 | 2-3 dÃ­as | Fase 1 | â³ Pending |
| Fase 3 | 4-5 dÃ­as | Fase 2 | â³ Pending |
| Fase 4 | 1-2 dÃ­as | Fase 3 | â³ Pending |
| Fase 5 | 1 dÃ­a | Fase 3 | â³ Pending |
| Fase 6 | 2-3 dÃ­as | Fase 1 | â³ Pending |
| Fase 7 | 2-3 dÃ­as | Fase 6 | â³ Pending |
| Fase 8 | 3-4 dÃ­as | Fase 7 | â³ Pending |
| Fase 9 | 2-3 dÃ­as | Fase 8 | â³ Pending |
| Fase 10 | 2-3 dÃ­as | Todas | â³ Pending |

---

## **Notas Importantes**

1. **Idioma**: Todo el proceso de grabaciÃ³n y transcripciÃ³n serÃ¡ en inglÃ©s para facilitar el anÃ¡lisis de IA
2. **Backward Compatibility**: Las aplicaciones existentes con BCQ texto seguirÃ¡n funcionando
3. **Storage**: Los videos se almacenan en bucket `business-case-videos` ya existente
4. **Transcription**: Utilizar `transcribe-video` edge function existente
